include:
  - ./docker-compose.yml

name: aoe-ci
services:

  aoe-web-frontend:
    networks:
      - default
    environment:
      - ENV=ci

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.playwright-test-runner 
    networks:
      - default
    volumes:
      - ./screenshots:/screenshots
      - ./playwright-results:/playwright-results
    environment:
      - CI=true
      - GITHUB_SHA
      - GITHUB_SERVER_URL
      - GITHUB_REPOSITORY
      - GITHUB_RUN_ID
    depends_on:
      nginx:
        condition: service_started

  aoe-streaming-app:
    environment:
      - NODE_ENV=development
    env_file:
      - path: ./aoe-streaming-app/.env.ci

  aoe-data-services:
    env_file:
      - path: ./aoe-data-services/.env.ci

  aoe-semantic-apis:
    env_file:
      - path: ./aoe-semantic-apis/.env.ci
        required: true

  aoe-data-analytics:
    env_file:
      - path: ./aoe-data-analytics/.env.ci

  aoe-web-backend:
    volumes:
      - ./aoe-web-backend/src:/app/src:rw
    environment:
      - NODE_ENV=development
    env_file:
      - ./aoe-web-backend/.env.ci

  postgres:
    volumes:
      - ./docker/init-scripts/aoe-init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./docker/init-scripts/aoe-user.sql:/docker-entrypoint-initdb.d/2-init.sql
      - ./docker/dev/postgres_data:/var/lib/postgresql/data

  opensearch:
    environment:
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Asfsadfsad!@2

  localstack:
    image: localstack/localstack:4.13.1@sha256:46302bcb91a7e8008e6394be8afafdbfa40fb77a54d4046a38be35992042d5de
    container_name: localstack 
    networks:
      default:
        aliases:
          - aoe.s3.localhost.localstack.cloud
          - aoepdf.s3.localhost.localstack.cloud
          - aoethumbnail.s3.localhost.localstack.cloud
    environment:
      - SERVICES=s3
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DEBUG="1"
      - HOSTNAME_EXTERNAL=localhost
    ports:
      - 4566:4566
    volumes:
      - ./docker/init-scripts/aws-shutdown.sh:/etc/localstack/init/shutdown.d/aws-shutdown.sh
      - ./docker/init-scripts/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
      - ./docker/dev/localstack/S3:/host-directory

  aoe-oidc-server:
    networks:
      - default
    expose:
      - 80
      - 443


  nginx:
    networks:
      default:
        aliases:
          - demo.aoe.fi

networks:
  default:
    name: aoe_ci

volumes:
  postgres_data:

secrets:
  trust_store_password:
    environment: TRUST_STORE_PASSWORD
