include:
  - ./docker-compose.yml

name: aoe-ci
services:

  aoe-web-frontend:
    networks:
      - default
    environment:
      - ENV=ci

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.playwright-test-runner 
    networks:
      - default
    volumes:
      - ./screenshots:/screenshots
      - ./playwright-results:/playwright-results
    environment:
      - CI=true
      - GITHUB_SHA
      - GITHUB_SERVER_URL
      - GITHUB_REPOSITORY
      - GITHUB_RUN_ID
    depends_on:
      nginx:
        condition: service_started

  aoe-streaming-app:
    hostname: aoe-streaming-app
    build:
      context: aoe-streaming-app
      dockerfile: ./docker/Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION}
    image: ${AOE_STREAMING_APP_TAG:-aoe-streaming-app:latest}
    container_name: aoe-streaming-app
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3001
    ports:
      - 3001:3001
    env_file:
      - path: ./aoe-streaming-app/.env.ci
    depends_on:
        localstack:
          condition: service_started

  aoe-data-services:
    hostname: aoe-data-services
    build:
      context: aoe-data-services
      dockerfile: ./Dockerfile
    image: ${AOE_DATA_SERVICES_TAG:-aoe-data-services:latest}
    restart: unless-stopped
    depends_on:
      aoe-web-backend:
        condition: service_healthy
    ports:
      - 8002:8002
    env_file:
      - path: ./aoe-data-services/.env.ci

  aoe-semantic-apis:
    hostname: aoe-semantic-apis
    build:
      context: aoe-semantic-apis
      dockerfile: ./docker/Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION}
    image: ${AOE_SEMANTIC_APIS_TAG:-aoe-semantic-apis:latest}
    container_name: aoe-semantic-apis
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=info
      - PORT_LISTEN=3002
    ports:
      - 3002:3002
    env_file:
      - path: ./aoe-semantic-apis/.env.ci
        required: true
    command: sh -c "npm run start"

  aoe-data-analytics:
    env_file:
      - path: ./aoe-data-analytics/.env.ci

  aoe-web-backend:
    volumes:
      - ./aoe-web-backend/src:/app/src:rw
    environment:
      - NODE_ENV=development
    env_file:
      - ./aoe-web-backend/.env.ci

  redis:
    image: redis:6.2.21-alpine@sha256:1bc63a4b0f4b8634f26f174b26f87d454bd85f81ca5e3faae75a4a050165f4d1
    container_name: redis
    privileged: true
    command: ["redis-server", "--requirepass", "dev_password", "--user", "devuser", "on", ">devuser_password", "~*", "+@all", "--user", "default", "off", "nopass", "nocommands"]
    restart: unless-stopped
    environment:
      REDIS_REPLICATION_MODE: master
    volumes:
      - ./docker/dev/redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -u redis://devuser:devuser_password@localhost:6379 ping | grep PONG"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 6379:6379

  postgres:
    volumes:
      - ./docker/init-scripts/aoe-init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./docker/init-scripts/aoe-user.sql:/docker-entrypoint-initdb.d/2-init.sql
      - ./docker/dev/postgres_data:/var/lib/postgresql/data

  opensearch:
    image: opensearchproject/opensearch:2.19.4@sha256:4f31f473cc452422deb6794cabdc4786cf90683eb2154b578c9ec33d30cea548
    container_name: opensearch
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Asfsadfsad!@2
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9200/_cluster/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - 9200:9200
      - 9600:9600

  mongodb:
    image: mongo:4.0
    container_name: aoe-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: aoerootuser
      MONGO_INITDB_ROOT_PASSWORD: aoerootpassword
      MONGO_INITDB_DATABASE: aoe
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
    volumes:
      - ./docker/dev/mongo_data:/data/db
      - ./docker/init-scripts/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js
    ports:
      - 27017:27017

  zookeeper:
    image: confluentinc/cp-zookeeper:7.9.5@sha256:61e960bcbe5796d2987edc61fab297387f63d6f831754576cd107543d2cdc8bb
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: ERROR
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    ports:
      - 2181:2181

  kafka:
    image: confluentinc/cp-kafka:7.9.5@sha256:c4c6b755551da17fff056b9c8b39700f99020083bd2d69a171ece4784f33e640
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,OUTSIDE://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,OUTSIDE:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_LOG4J_ROOT_LOGLEVEL: ERROR
      KAFKA_LOG4J_LOGGERS: kafka=ERROR,kafka.network.RequestChannel$=ERROR,kafka.producer.async.DefaultEventHandler=ERROR,kafka.request.logger=ERROR,kafka.controller=ERROR,kafka.log.LogCleaner=ERROR,state.change.logger=ERROR,kafka.authorizer.logger=ERROR
    ports:
      - 29092:29092
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "9092" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  kafka2:
    image: confluentinc/cp-kafka:7.9.5@sha256:c4c6b755551da17fff056b9c8b39700f99020083bd2d69a171ece4784f33e640
    container_name: kafka2
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka2:9092,OUTSIDE://kafka2:39092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,OUTSIDE:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_LOG4J_ROOT_LOGLEVEL: ERROR
      KAFKA_LOG4J_LOGGERS: kafka=ERROR,kafka.network.RequestChannel$=ERROR,kafka.producer.async.DefaultEventHandler=ERROR,kafka.request.logger=ERROR,kafka.controller=ERROR,kafka.log.LogCleaner=ERROR,state.change.logger=ERROR,kafka.authorizer.logger=ERROR
    ports:
      - 39092:39092
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "9092" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  localstack:
    image: localstack/localstack:4.13.1@sha256:46302bcb91a7e8008e6394be8afafdbfa40fb77a54d4046a38be35992042d5de
    container_name: localstack 
    networks:
      default:
        aliases:
          - aoe.s3.localhost.localstack.cloud
          - aoepdf.s3.localhost.localstack.cloud
          - aoethumbnail.s3.localhost.localstack.cloud
    environment:
      - SERVICES=s3
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DEBUG="1"
      - HOSTNAME_EXTERNAL=localhost
    ports:
      - 4566:4566
    volumes:
      - ./docker/init-scripts/aws-shutdown.sh:/etc/localstack/init/shutdown.d/aws-shutdown.sh
      - ./docker/init-scripts/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
      - ./docker/dev/localstack/S3:/host-directory

  aoe-oidc-server:
    networks:
      - default
    expose:
      - 80
      - 443


  nginx:
    networks:
      default:
        aliases:
          - demo.aoe.fi

networks:
  default:
    name: aoe_ci

volumes:
  postgres_data:

secrets:
  trust_store_password:
    environment: TRUST_STORE_PASSWORD
