FROM node:20-alpine3.22@sha256:ddd498cc4378e4f69b0298f00c21c6f1d0a1d14f51261552e9d91614990630ce

WORKDIR /app

COPY package.json package-lock.json ./
COPY vendor ./vendor/

RUN npm ci

RUN apk add --no-cache \
    fontconfig \
    libreoffice \
    ttf-dejavu \
    ttf-freefont \
    ttf-liberation

COPY docker ./docker/

RUN mkdir -p /app/h5p && \
    unzip /app/docker/h5p.zip -d /app/h5p

# Copy source files into application directory
COPY --chown=app:app . /app

EXPOSE 3000

RUN npm run build-ts

COPY ./src/search/aoemapping.json /app
COPY ./src/search/aoecollectionmapping.json /app

ENTRYPOINT ["./docker/entrypoint.sh"]
